# 开发计划：电子版《快餐连锁大亨》（Godot）

本文档基于 `docs/design.md` 的技术方案，给出可落地的端到端开发计划（里程碑、任务分解、验收标准、风险与测试策略），用于驱动实现一款**数据驱动 + 可插拔扩展 + 可复盘/可存档**的电子版桌游。

---

## 0. 目标、范围与成功标准

### 0.1 产品目标（What）

- 完整实现基础规则的单机对局：设置 → 七阶段循环 → 银行破产/终局 → 结算与复盘。
- 架构目标：
  - **命令模式 + 事件溯源**：存档/回放/撤销围绕 `Command` 流。
  - **插件化模块系统**：扩展模块通过注册表/钩子注入，不修改核心逻辑。
  - **数据驱动**：员工、里程碑、地图板块、营销板件等均由资源/配置定义。
- 后续扩展目标（主体功能完成后进入）：
  - **联网联机**：基于命令流的同步/回放与断线重连能力。
  - **AI 对手**：可配置难度的对局 AI（规则内决策），并可用回放复现与调试。
- 体验目标（MVP 级别）：
  - “能玩且不出错”：规则校验明确、强制行动可见、关键流程不卡死。
  - 回放一致：相同初始状态+命令序列得到相同结果。

### 0.2 范围边界（What Not）

- 当前阶段不追求最终美术质量；优先功能正确、信息清晰、可调试。
- 当前阶段不考虑移动端适配。
- 当前阶段暂不做入门模式（规则简化开关）。
- 联网联机与 AI 会纳入路线图，但放在主体功能完成之后实施。

### 0.3 成功标准（Definition of Done）

- 基础规则覆盖率：设计文档列出的关键规则点全部落地（阶段推进、距离/路径、营销、晚餐竞价与平局、薪资与破产等）。
- 可用性：
  - 完整一局可结束（终局路径至少 2 种：正常终局/第二次破产终局）。
  - 强制动作阻断：未完成强制行动无法结束阶段，并给出可导航入口。
- 工程质量：
  - 关键子系统具备自动化验证（回放一致性/现金守恒/数量守恒/关键校验器）。
  - 最少 1 套“黄金回放（golden replay）”用例：每次改动可验证不回归。

---

## 1. 里程碑路线图（建议按 1~2 周一个 Sprint）

下列里程碑以“可验证的可玩增量”为主，每个里程碑都应产出可运行 Demo + 用例（回放/测试场景）。

### M0：工程初始化与骨架（1–3 天）

**交付物**

- Godot 工程与目录骨架（建议 Godot 4.x + GDScript）。
- 基础运行框架：主菜单 → 新游戏 → 进入 Game 场景。
- 基础日志与调试开关（开发版）。

**验收标准**

- 可在编辑器一键运行，进入空白地图界面。
- 有最小的 `GameState` 与 `Command` 数据结构占位（可序列化）。

---

### M1：核心引擎（命令/状态机/事件）（1 Sprint）

**目标**：把“规则变化”收敛为可重放的命令流。

**交付物**

- `Command`、`ActionExecutor`、`ActionRegistry`、`GameEngine.execute_command()`。
- `PhaseManager`：七阶段 FSM（含子阶段入口），支持阶段钩子（before/after enter/exit）。
- `EventBus`：动作执行产生事件，UI/模块可订阅。
- 校验器框架：通用 `Result{ok,error}`，以及按动作/阶段挂载的验证器链。

**验收标准**

- 录入一段命令序列可 deterministically 重放（至少 20+ 命令）。
- 阶段推进可自动/手动结束，且阶段进入/退出钩子按优先级稳定执行。

---

### M2：地图烘焙 + 道路图 + 放置校验（1–2 Sprints）

**目标**：落实 `TileDef/MapDef` → `map.cells` 下沉，并提供距离/连通/放置校验能力。

**交付物**

- Map Baking：读取 `TileDef/MapDef`，生成世界格 `map.cells[y][x]` 与必要索引（房屋、饮品源、板块边界等）。
- 板块编辑器（游戏内工具，首版可简单但可用）：
  - 编辑/可视化 `road_segments`、`printed_structures`、`drink_sources` 等字段；
  - 数据校验与预览渲染（格子/道路/桥/房屋编号/饮品源图标）；
  - 一键导出/保存 JSON（统一资源格式）。
- `RoadGraph`：按 `road_segments` 构图，支持桥（多段互不相通）、街区划分（供 mailbox）、最短路（距离的“跨板块边界次数”计数）。
- 放置 API 收敛：所有放置/校验统一使用世界格坐标；实现结构占位、旋转、冲突检查。
- 房屋编号系统：印刷房屋与运行时放置房屋统一编号/排序策略。

**验收标准**

- 给定地图配置，能正确计算：
  - 两点最短路距离与“跨板块次数”；
  - 连通性（餐厅入口到房屋服务边）；
  - 桥格的“竖直不连水平”的特殊情况。
- 放置餐厅/房屋/营销件时，冲突与非法原因可解释（UI 或日志至少一种）。
- 编辑器导出的 JSON 可被游戏直接加载并完成烘焙，且导出前后内容（语义上）一致。

---

### M3：公司/员工/库存/基础经济闭环（1–2 Sprints）

**目标**：形成“工作阶段 → 晚餐 → 发薪/清理”的最小可玩闭环。

**交付物**

- 公司结构（金字塔）数据模型与校验器链（CEO 卡槽、经理层级、忙碌营销员、唯一性等）。
- 员工资源（`EmployeeDef`）与基础动作：
  - Recruit / Train / Fire / Restructure（或在对应阶段以组合动作实现）。
  - Mandatory Actions：定价/折扣/奢侈品等强制行动的框架与 UI 阻断。
- 库存模型与动作：生产/采购（含饮品源约束）、清理（冰箱容量策略按设计文档）。
- 经济模型最小实现：现金账户、转账（银行对冲），现金守恒检查。

**验收标准**

- 一局中可完成：招人→生产/采购→晚餐结算→发薪→清理→下一回合。
- 现金/库存数量守恒（除明确的“无限供应/银行”来源外）。

---

### M4：营销系统 + 晚餐竞争完整规则（1–2 Sprints）

**目标**：实现最关键的博弈系统：营销产生需求、晚餐竞争与平局规则、价格管道。

**交付物**

- 营销资源（`MarketingDef`）与实例生命周期（持续时间 tokens、按编号结算、按人数移除特定 board_number）。
- RangeCalculator：billboard/mailbox/radio/airplane（按设计文档的范围算法）。
- 晚餐时间：
  - 候选餐厅筛选：连通 + 库存可满足全部需求；
  - 胜负判定：最小（单价+距离）→ 平局比女服务员数量 → 仍平局按回合顺序；
  - 收入：单价×数量 + 奖励；花园翻倍“单价部分”；负收入钳制为 0；CFO 倍增向上取整；女服务员统一收取（3 或里程碑至 5）。
- `PricingPipeline`：可注册修饰器（里程碑、模块、地形、公园倍增等）。

**验收标准**

- 对同一局面，结算结果（赢家/收入/库存变化/现金变化）与规则一致，并可被日志解释。
- 至少 3 套“晚餐结算场景”回放用例覆盖：花园翻倍、平局链路、库存不足导致候选剔除。

---

### M5：里程碑 + 模块系统（核心插件化）（1 Sprint）

**目标**：把“变体规则”从核心剥离到模块。

**交付物**

- 里程碑系统：触发器、授予、移除、效果应用（对定价/行动/阶段/公司结构等的影响通过注册表实现）。
- 模块系统 V2（严格模式，见 `docs/architecture/60-modules-v2.md`）：
  - 模块包目录化：`res://modules/<module_id>/module.json` + `README.md`
  - 依赖/冲突检查 + 确定性排序
  - 严格内容装配：员工/里程碑等只从启用模块加载（禁用=不存在）
  - 供应池推导：从内容元数据构建员工/里程碑池（不再在 `GameConfig` 写死类似 `one_x_employee_ids` 的列表）
  - 规则注册：Phase Hooks、Pricing Modifiers、Validators、RangeCalculators、Tiebreakers
  - 结算注册：SettlementRegistry；缺主结算器初始化直接失败（Fail Fast）
- 至少 2 个参考模块骨架（按设计文档示例选取）：
  - 例如：夜班经理（阶段钩子复制无薪行动）、大众营销员（营销额外轮次）。

**验收标准**

- 不改核心代码，仅通过启用模块即可改变行为（可用 1 个对局回放验证差异）。
- 存档记录模块版本/哈希，回放时校验不一致则拒绝加载或提示迁移策略。
- 禁用模块后，其员工/里程碑在运行期 registry 与供应池中均不可见；若缺必需结算器/能力则初始化直接失败且报错可定位模块。

---

### M6：存档/复盘 + 调试工具 + 新手体验（1–2 Sprints）

**目标**：提升可维护性与可玩性，确保开发效率。

**交付物**

- ReplayArchive：初始快照 + command_log + checkpoints（按设计文档建议间隔）。
- 回放引擎：模块验证、校验点验证、失败定位（第 N 条命令）。
- 撤销/重做（阶段内）+ 阶段确认锁定；高风险操作确认框。
- Debug Console（开发版）：跳阶段、加钱/加库存、dump_state、verify 守恒等。
- 新手体验（按优先级选择实现）：
  - MandatoryActionBlocker（强制动作锁定）；
  - ContextHelp（上下文帮助）；
  - Tutorial（渐进教学）与 ActionPreview（收益预测）可作为后续增强项。

**验收标准**

- 任意对局可存档并在相同版本下复盘一致。
- 关键 debug 命令可快速构建测试场景（例如一键跳到晚餐、生成指定需求/营销布局）。

---

### M7：AI 对手（主体功能完成后）（1–2 Sprints）

**目标**：实现可调试、可复现、可扩展的 AI 决策系统，保证不破坏确定性与回放一致性。

**交付物**

- AI 框架：
  - `DecisionPolicy` 接口：输入为只读的 `GameState` + 可执行动作列表，输出为 `Command`（或“pass/结束阶段”）。
  - 规划器（可先用启发式 + 打分）：对候选动作进行模拟评估（通过“沙盒执行器/克隆状态”或轻量评估函数）。
- 难度分层：
  - Easy：规则合法即可（偏随机/弱启发式）。
  - Normal：考虑短期收益（库存、距离、价格竞争、营销覆盖）。
  - Hard：考虑 1–2 回合的粗略前瞻（受限搜索深度）。
- 调试工具：
  - 输出 AI 决策解释（top-N 备选及评分分解），并可写入回放 metadata。

**验收标准**

- AI 对局可完整结束，且不会生成非法命令（或非法时能自愈并给出可追踪原因）。
- 同 seed/同命令序列（包含 AI 决策结果）可 100% 复盘一致。

---

### M8：联网联机（主体功能完成后）（2–4 Sprints）

**目标**：在“命令即真相”的架构下实现稳定联机：同步、断线重连、反作弊/反串改的基本防线（按需求取舍）。

**已确定技术路线（以复用与一致性为最高优先级）**

- 回合制/非即时的 **Host 权威 + Lockstep 命令同步**：
  - Host 跑同一套 `GameEngine`/校验器，负责裁决并广播“已确认命令”；
  - 客户端 UI 只负责生成“命令提案”；可选本地预测，但以 Host 确认序列为准。
- **仅同步 `Command`**（外加少量会话事件，如玩家加入/准备/断线），不直接同步状态。
- **断线重连（首版支持）**：
  - 重连时 Host 下发 `initial_state + confirmed_command_log + latest_checkpoint`；
  - 客户端复用 `ReplayEngine/TimeTravel` 重建到最新状态，并用 `state_hash + key_values` 校验一致性。
- **首版不支持中途加入**；观战后置（本质为只读客户端消费命令流/回放流）。
- **Host 与 Dedicated Server 统一代码路径**：
  - 抽象 `ServerSession`（可 headless 运行）作为权威会话；
  - “本地主机联机”=本机启动 `ServerSession` + 本机客户端连接；未来 Dedicated 只改变启动形态。

**交付物**

- 会话与网络框架（建议拆分）：
  - `ServerSession`：权威命令队列、校验、确认广播、checkpoint 生成。
  - `ClientSession`：命令提案、确认接收、回放重建、断线重连流程。
- 房间创建/加入、玩家身份/座位分配、准备开始、掉线重连。
- 命令确认机制（ACK/序号连续性）与顺序保证。
- Desync 检测与处理：
  - 客户端定期上报 `state_hash`；
  - 不一致时可请求 Host 下发快照并重放到最新命令（Time Travel 复用）。
- 安全与一致性（基础版）：
  - Host 校验命令合法性（禁止客户端绕过校验器）；
  - 回放记录网络元信息（玩家 id、延迟、版本、模块 hash）。

**验收标准**

- 两台客户端可完整对局并结束，过程中允许至少一次断线重连并继续游戏。
- 出现 desync 时能自动检测并恢复（重同步），或至少明确报错并保留诊断信息。

---

## 2. 详细任务分解（WBS）

本节按子系统列出工作项；实现时建议每个工作项都绑定：

- 需求描述（输入/输出/约束）
- 代码入口（类/资源/场景）
- 验收用例（回放或测试场景）

### 2.1 核心工程与规范

- 目录约定（建议）：
  - `core/`：引擎核心（GameState、Command、Phase、Registry、Pipeline）
  - `gameplay/`：具体动作与规则实现（ActionExecutors、Validators）
  - `data/`：JSON（EmployeeDef、MilestoneDef、TileDef、MapDef、PieceDef、MarketingDef、GameConfig；ModuleDef 预留）
  - `ui/`：场景与控件（Panels、Views、Dialogs）
  - `tools/`：调试与编辑器工具（可选）
- 配置：
  - 本地化框架与语言切换（默认中文，支持英文）。
  - 日志等级（INFO/WARN/ERROR）与回放/校验日志开关。
- 技术栈约束（已确定）：
  - 引擎：Godot 4.x
  - 脚本：GDScript
  - 数据资源：统一使用 JSON（建议带 `schema_version` 字段，便于演进与迁移）

### 2.2 命令与状态（事件溯源）

- `GameState`（不可变/尽量纯更新）：
  - 现金账户（bank、player:N）、库存、公司结构、地图 cells、营销实例、里程碑、回合/阶段信息。
- `Command` 结构与序列化（JSON/二进制任选，但需稳定版本）。
- `ActionExecutor` 标准接口：
  - `validate()`（纯函数）与 `compute_new_state()`；
  - `generate_events()` 用于 UI/日志/里程碑触发。
- `StateUpdater`：封装常用更新与银行对冲，避免手写深层赋值错误。

### 2.3 阶段 FSM 与钩子系统

- `PhaseManager`：
  - 七阶段与工作阶段子阶段编排；
  - “可用行动列表”与“自动推进条件”；
  - Hook 注册（before/after enter/exit）+ priority 排序。
- `OrderOfBusiness`：
  - 比较器链（空余卡槽、上一回合顺序、首个飞机营销 +2 等）。

### 2.4 地图、道路与距离

- Map Baking（一次性下沉）：
  - `printed_structures`、`drink_sources` → `map.cells` 与索引。
- `RoadGraph`：
  - 构图：格内段、段内连通、跨格方向连接；
  - 桥：同格多段不相交；
  - 距离：最短路 + 跨板块边界计数（烘焙期建立边界索引，运行期不查 tile）。
- 街区 `BlockRegions`：
  - 供 mailbox 范围计算（同街区）。
- 放置系统：
  - `PieceDef` footprint/anchor/rotation；
  - 统一校验入口与写入 API（世界格坐标）。

### 2.5 公司结构与员工

- `EmployeeDef`：
  - 薪资标记、唯一性、经理卡槽、训练路线、range 类型等。
- Company Structure：
  - CEO 顶点、经理约束、忙碌营销员移出结构但仍付薪；
  - 重组阶段的自动纠错（超限则除 CEO 外转待命）。
- 员工动作：
  - Recruit：供应池、缺货预支与“紧接培训”约束；
  - Train：中间职位可缺货，仅要求最终职位有牌；
  - Fire：回供应池；
  - Mandatory Actions：SetPrice/SetDiscount/SetLuxuryPrice 等。

### 2.6 库存、生产/采购与清理

- 库存模型：食品/饮品无限供应的表现方式（仍需记录玩家库存数）。
- 采购员路径规则：
  - 起点餐厅入口；禁 U 型掉头；饮品标志“同采购员同来源每回合一次”，但多采购员可依次拾取。
- 清理阶段：
  - 无冰箱则清空；
  - 有容量则限幅（按设计文档的“每种各自限幅”简化策略）。

### 2.7 营销系统

- `MarketingDef`：占位 + 效果范围 + board_number + duration。
- 放置规则：
  - billboard/mailbox/radio：空格且邻接道路；radio 不要求与自家连通；
  - airplane：地图边缘放置（`edge/index`），不占世界格，仅登记实例。
- 结算：
  - 营销阶段按 board_number 升序，过滤 removed_board_numbers；
  - 结算后 duration -1，过期移除；
  - 需求上限：普通 3，带花园 5。

### 2.8 晚餐时间与定价管道

- 需求来源：营销生成的需求落到房屋（或区域），并在晚餐结算后清空需求。
- 候选餐厅筛选：连通 + 库存满足全部需求（“能满足全部需求”是硬条件）。
- 胜负判定：最小（单价+距离）→ 女服务员数量 → 回合顺序。
- 收入计算：
  - 花园翻倍“单价部分”；奖励不翻倍；
  - 负收入钳制为 0；
  - CFO：现金×1.5 向上取整（含女服务员），对 0 收入自然无增益。
- `PricingPipeline`：
  - 基础单价、折扣、奢侈品、里程碑、模块、地形等通过 Modifier 注入；
  - 执行顺序稳定（priority）。

### 2.9 里程碑与扩展模块

- 里程碑：
  - Trigger（基于事件）+ Effects（注册到对应系统）。
  - 独占类型、可过期（Hard Choices 模块）。
- 模块系统：
  - enable/disable 时注册/撤销钩子、验证器、修饰器、比较器；
  - UI 仅展示元数据，实际生效靠注册逻辑。

### 2.10 存档、复盘与一致性验证

- ReplayArchive：
  - initial_state、seed、modules、command_log、checkpoints（state_hash + key_values，必要时 full_snapshot）。
- ReplayEngine：
  - 模块版本/哈希校验；
  - 命令执行失败定位；
  - 校验点偏差对比输出（便于定位回归）。
- 一致性策略：
  - 受控随机：所有随机必须由 seed 驱动并写入命令/事件（例如地图朝向、抽牌等）。
  - 守恒检查：现金守恒、牌库数量守恒、库存非负等。
- 为联机/AI 预留的确定性要求（建议尽早遵守）：
  - 规则计算尽量使用整数；避免依赖浮点与非确定性迭代顺序（Dictionary/Set 遍历需排序）。
  - 所有“排序/平局”规则必须显式定义并稳定（例如按房屋编号、board_number、玩家顺序）。

### 2.11 UI（按“能玩优先”分层）

**P0（必须）**

- Game HUD：阶段、回合、玩家信息、结束阶段按钮。
- CompanyView：员工拖拽排布 + 结构校验提示。
- Board：放置预览（footprint 高亮 + 冲突提示）、道路/结构渲染。
- MandatoryActionBlocker：强制行动未完成不可结束阶段，并提供“前往完成”导航。

**P1（强烈建议）**

- Dinnertime 结果面板：逐屋结算列表 + 平局原因解释。
- ContextHelp：右侧帮助栏按阶段更新。

**P2（增强）**

- Undo/Redo（阶段内）与 ConfirmationSystem。
- 回放观战、决策历史、互动式晚餐、收益预测、智能推荐等（按设计文档优先级逐步实现）。
- （后续）联机大厅与房间 UI、AI 难度选择与 AI 调试面板。

---

## 3. 测试与质量保障（推荐做法）

### 3.1 测试层级

- 规则单元测试（纯函数优先）：Validator、PricingModifier、RangeCalculator、TieBreaker、RoadGraph shortest path。
- 集成测试（回放驱动）：
  - 固定 seed + 固定地图 + 固定命令序列 = 固定 final_state hash；
  - “黄金回放”用例（至少 5 个，覆盖关键机制）。
- 不变量检查（每条命令后可选开启）：
  - 现金守恒（bank + Σplayers 恒定，或符合已定义“凭空生成/销毁”规则）；
  - 库存非负；
  - 员工供应池与玩家持有总量守恒；
  - 公司结构规则满足（阶段结束/关键节点）。

### 3.2 回归策略

- 每次改动影响规则时，必须更新或新增对应回放用例，并写明变更原因。
- 对 UI 改动，至少保证命令日志不受影响（UI 只是命令的生产者）。

---

## 4. 风险清单与对策

- **规则复杂且容易漏细节**：以“可复盘 + 可解释日志 + 场景回放”作为主防线；每个规则点至少 1 个最小场景回放。
- **地图/道路图实现难度高**：优先把 `RoadGraph` 与距离/连通做成纯模块并先用命令行/测试验证，再接 UI。
- **插件化导致调试困难**：强制所有注册项打印可追踪的“来源（模块/里程碑/核心）+ priority”；提供 Debug Console 查看当前注册表快照。
- **一致性被随机/浮点破坏**：统一使用整数/有理数（如价格、距离、收入均为 int），浮点仅用于 UI 动画；随机必须写入命令或由 seed 驱动。

---

## 5. 待确认问题（建议尽早锁定）

### 5.1 已确定

1. 统一 Godot 4.x + GDScript。
2. 资源格式统一使用 JSON。
3. 地图需要随机拼接，并制作板块编辑器（游戏内工具，用于手动编辑板块数据与可视化）。
4. 暂不考虑移动端。
5. 暂不做入门模式。
6. 联机对战方案（为复用与一致性最大化）：
   - 权威模型：Host 权威裁决（Host 负责校验与确认命令）。
   - 同步粒度：仅同步 `Command`（外加少量会话事件），状态不直接同步。
   - 断线重连：首版支持（通过下发回放/快照 + 已确认命令重建）。
   - 中途加入：首版不支持；观战后置（按“只读回放流”实现）。
   - Host 与 Dedicated Server：统一同一条代码路径（`ServerSession` 可 headless 运行；本地主机=本机启动服务会话）。
7. 联机掉线托管：不允许掉线后由 AI 接管对局（不提供 AI 代打/托管）。

### 5.2 仍需确认（建议补充）

1. 联机约束细节：回合制节奏下的超时策略（弃权/自动结束阶段/暂停等待重连）、投票与托管规则。
2. 安全目标：是否需要反作弊（命令签名/回放校验/重放验证），以及做到什么强度。

### 5.3 联机对设计的“最小前置决策”（建议现在拍板，其余可延后）

即使联机实现放到主体功能之后，也建议尽早确定下列最小决策；它们会显著影响当前代码的边界划分与确定性约束：

1. **权威模型**：是否采用“Host 权威裁决 + 广播确认命令”（推荐），还是完全 P2P 对等？
2. **同步粒度**：是否坚持“只同步命令（Command）”并以回放作为事实来源（推荐），还是同步状态/差量？
3. **重连策略**：是否必须支持断线重连（推荐支持），以及重连时下发 `ReplayArchive` 还是“快照+增量命令”？
4. **中途加入/观战**：是否允许中途加入（通常不建议首版支持），观战是否必须（可后置）。

> 注：以上 4 项已在 5.1 中确认，保留本小节用于解释“为何这些需要尽早定”。
